#!/bin/sh

# 设置默认配置文件路径
: ${CONFIG_FILE:=config/config.yaml}

echo "Using config file: $CONFIG_FILE"

# 从配置文件路径中提取目录
CONFIG_DIR=$(dirname "$CONFIG_FILE")

# 确保配置目录存在
if [ ! -d "$CONFIG_DIR" ]; then
    echo "Creating config directory: $CONFIG_DIR"
    mkdir -p "$CONFIG_DIR"
fi

# 如果配置文件不存在，创建默认配置文件
if [ ! -f "$CONFIG_FILE" ]; then
    echo "Creating default config file: $CONFIG_FILE"
    cat > "$CONFIG_FILE" << 'EOF'
# 默认配置文件


notifiers: {}

templates: {}

notification_apps: {}
EOF
    # 设置配置文件权限
    chmod 644 "$CONFIG_FILE"
    echo "Default config file created successfully"
fi

# 检查并设置PGID和PUID的默认值
: ${PGID:=1000}
: ${PUID:=1000}

echo "Setting PGID to $PGID and PUID to $PUID"

# 修改组ID
if [ "$PGID" != "1000" ]; then
    groupmod -o -g "${PGID}" notify
fi

# 修改用户ID
if [ "$PUID" != "1000" ]; then
    usermod -o -u "${PUID}" notify
fi

chown -R notify:notify \
    "${HOME}" \
    /app \
    "$CONFIG_DIR" 

# 设置默认umask
: ${UMASK:=022}
umask "${UMASK}"

echo "Starting notification service as notify user (${PUID}:${PGID})"
# 启动后端服务
exec gosu notify:notify /app/notify
